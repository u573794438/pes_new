{% extends 'base.html' %}

{% block title %}生成考评结果 - 员工绩效互评系统{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">生成考评结果</h4>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('evaluation_results.admin_generate_evaluation_results') }}">
    {{ form.hidden_tag() }}  {# 渲染所有隐藏字段，包括CSRF令牌 #}
    {% if form.csrf_token %}  {# 检查CSRF令牌是否存在 #}
        <input type="hidden" name="csrf_token" value="{{ form.csrf_token._value() }}">
        {% if form.csrf_token.errors %}
            <div class="alert alert-danger">CSRF令牌错误: {{ form.csrf_token.errors[0] }}</div>
        {% endif %}
    {% else %}
        <div class="alert alert-danger">CSRF令牌未定义</div>
    {% endif %}
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label for="task_id" class="form-label">选择评估任务</label>
                            <select id="task_id" name="task_id" class="form-select" required>
                                <option value="">请选择任务</option>
                                {% for task in tasks %}
                                <option value="{{ task.id }}" {{ 'selected' if selected_task_id == task.id|string else '' }}>{{ task.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="department_rating" class="form-label">部门绩效评级</label>
                            <select id="department_rating" name="department_rating" class="form-select" required>
                                <option value="甲" {{ 'selected' if selected_department_rating == '甲' else '' }}>甲</option>
                                <option value="乙" {{ 'selected' if selected_department_rating == '乙' else '' }}>乙</option>
                                <option value="丙" {{ 'selected' if selected_department_rating == '丙' else '' }}>丙</option>
                                <option value="丁" {{ 'selected' if selected_department_rating == '丁' else '' }}>丁</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">生成结果</button>
                </form>
            </div>
        </div>
    </div>

    {% if results %}
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h4 class="mb-0">{{ task_name }} - 绩效考评结果</h4>
            </div>
            <div class="card-body">
                <div class="bg-light rounded-lg p-2 mb-3 border border-gray-200">
                    <div class="d-flex items-center mb-1">
                        <span class="badge bg-primary mr-2 text-sm">部门信息</span>
                        <p class="text-muted mb-0 text-sm"><strong>部门绩效评级：</strong>{{ selected_department_rating }}</p>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6 mb-2">
                        <div class="bg-light rounded-lg p-2 border border-gray-200 h-100">
                            <h6 class="text-primary mb-1 text-sm">绩效等级分布规则</h6>
                            <ul class="text-muted list-disc pl-5 mb-0 text-sm">
                                <li>A档：原则上不低于90分</li>
                                <li>B档：原则上不低于80分</li>
                                <li>C档：原则上不低于70分</li>
                                <li>D档：小于70分</li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-6 mb-2">
                        <div class="bg-light rounded-lg p-2 border border-gray-200 h-100">
                            <h6 class="text-primary mb-1 text-sm">部门绩效与等级比例</h6>
                            <ul class="text-muted list-disc pl-5 mb-0 text-sm">
                                {% if selected_department_rating == '甲' %}
                                <li>A类员工占比：40%，B类员工占比：30%</li>
                                {% elif selected_department_rating == '乙' %}
                                <li>A类员工占比：20%，B类员工占比：20%</li>
                                {% elif selected_department_rating == '丙' %}
                                <li>A类员工占比：15%，B类员工占比：20%</li>
                                {% else %}
                                <li>A类员工占比：10%，B类员工占比：20%</li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="bg-light rounded-lg p-2 mb-3 border border-gray-200">
                    <h6 class="text-primary mb-1 text-sm">最终分数计算逻辑</h6>
                    <ul class="text-muted list-disc pl-5 mb-0 text-sm">
                        <li>加权合计分数 = 部门负责人分数 × 40% + 部门经理分数 × 15% + 员工互评分数 × 15% + 分管领导分数 × 30%</li>
                        <li>最终分数 = 加权合计分数 × 岗位系数</li>
                        <li>若最终分数超过99分，则取99分作为最终结果</li>
                    </ul>
                </div>

                <form method="POST" action="{{ url_for('evaluation_results.export_evaluation_results') }}" style="display: inline;">
    {{ form.hidden_tag() }}  {# 渲染所有隐藏字段，包括CSRF令牌 #}
    {% if form.csrf_token %}  {# 检查CSRF令牌是否存在 #}
        <input type="hidden" name="csrf_token" value="{{ form.csrf_token._value() }}">
    {% endif %}
                    <input type="hidden" name="task_id" value="{{ selected_task_id }}">
                    <input type="hidden" name="department_rating" value="{{ selected_department_rating }}">
                    <button type="submit" class="btn btn-success mb-3">导出Excel</button>
                </form>

                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>姓名</th>
                                <th>岗位</th>
                                <th>部门负责人分数</th>
                                <th>部门经理分数</th>
                                <th>员工互评分数</th>
                                <th>分管领导分数</th>
                                <th>最终分数</th>
                                <th>绩效等级</th>
                                <th>分数排名</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for result in results %}
                            <tr>
                                <td>{{ result.name }}</td>
                                <td>{{ result.position }}</td>
                                <td>{{ result.dept_head_score|round(2) }} 分</td>
                                <td>{{ result.dept_manager_score|round(2) }} 分</td>
                                <td>{{ result.peer_score|round(2) }} 分</td>
                                <td>{{ result.leader_score|round(2) }} 分</td>
                                <td>{{ result.final_score|round(2) }} 分</td>
                                <td>
                                    <span class="badge {% if result.performance_level == 'A' %}bg-success{% elif result.performance_level == 'B' %}bg-primary{% elif result.performance_level == 'C' %}bg-warning{% else %}bg-danger{% endif %}">
                                        {{ result.performance_level }}
                                    </span>
                                </td>
                                <td>{{ result.rank }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}