{% extends 'base.html' %}

{% block title %}我的评估记录{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2>我的评估记录</h2>
    
    {# 简化的条件判断逻辑 #}
{% set returned_evaluations = evaluations|selectattr('status', 'equalto', 'returned')|list %}
{% set has_returned_evaluations = returned_evaluations|length > 0 %}

{# 增强的调试信息 #}
<div class="alert alert-info mb-4">
    评估记录总数: {{ evaluations|length }}<br>
    已退回评估数量: {{ returned_evaluations|length }}<br>
    存在已退回评估: {{ '是' if has_returned_evaluations else '否' }}
    {% if returned_evaluations %}
        <br>已退回评估ID列表: {{ returned_evaluations|map(attribute='id')|list }}
    {% endif %}
</div>
    
{% if has_returned_evaluations %}
    <div class="mb-4">
        <button type="button" class="btn btn-success btn-lg" data-bs-toggle="modal" data-bs-target="#reassessAllModal">
            一键重新评估所有已退回评估
        </button>
    </div>
    {% endif %}

    <!-- 一键重新评估模态框 -->
    <div class="modal fade" id="reassessAllModal" tabindex="-1" role="dialog" aria-labelledby="reassessAllModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reassessAllModalLabel">一键重新评估</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>确认要重新评估所有已退回的评估记录吗？</p>
                    <form action="{{ url_for('batch_reassess_evaluations') }}" method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="modal-footer">
                            <button type="button" class="btn-secondary" data-bs-dismiss="modal">取消</button>
                            <button type="submit" class="btn-primary">确认重新评估</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <hr>

    {% if evaluations %}
        {% for task, task_evaluations in evaluations|groupby('task') %}
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">{{ task.name }}</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>姓名</th>
                                {% for dimension in dimensions %}
                                <th>{{ dimension.name }}({{ (dimension.weight * 100)|int }}%)</th>
                                {% endfor %}
                                <th>合计</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for evaluation in task_evaluations %}
                            <tr>
                                <td>{{ evaluation.evaluatee.name }}</td>
                                {% for dimension in dimensions %}
                                <td>{% set dim = evaluation.scores|selectattr('dimension.id', 'equalto', dimension.id)|first %}{{ (dim.score * (dimension.weight * 20))|int if dim else 0 }}</td>
                                {% endfor %}
                                <td>{{ evaluation.total_score|int }}</td>
                                <td>
                                    {% if evaluation.status == 'submitted' %}
                                        <span class="badge badge-success">已提交</span>
                                    {% elif evaluation.status == 'returned' %}
                                        <span class="badge badge-warning">已退回</span>
                                    {% elif evaluation.status == 'withdrawal_requested' %}
                                        <span class="badge badge-info">撤回申请中</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if evaluation.status == 'submitted' %}
                                        <span class="text-muted">任务级撤回</span>
                                    {% elif evaluation.status == 'returned' %}
                                        <a href="{{ url_for('get_evaluation_form', evaluatee_id=evaluation.evaluatee.id) }}" class="btn btn-primary btn-sm">
                                            重新评估
                                        </a>
                                    {% elif evaluation.status == 'withdrawal_requested' %}
                                        <span class="text-muted">等待审核</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- 任务级申请撤回模态框 -->
                <div class="modal fade" id="withdrawModal{{ task.id }}" tabindex="-1" role="dialog" aria-labelledby="withdrawModalLabel{{ task.id }}" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="withdrawModalLabel{{ task.id }}">申请撤回评估任务: {{ task.name }}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <p>确认要撤回此任务下的所有评估记录吗？</p>
                                <form action="{{ url_for('request_withdrawal', task_id=task.id) }}" method="POST">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <div class="form-group">
                                        <label for="reason{{ task.id }}">撤回原因</label>
                                        <textarea class="form-control" id="reason{{ task.id }}" name="reason" rows="3" required></textarea>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn-secondary" data-bs-dismiss="modal">取消</button>
                                        <button type="submit" class="btn-primary">提交申请</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 任务级申请撤回按钮 -->
                {% set all_submitted = true %}
                {% set has_withdrawal_requested = false %}
                {% for evaluation in task_evaluations %}
                    {% if evaluation.status != 'submitted' %}
                        {% set all_submitted = false %}
                    {% endif %}
                {% endfor %}
                {% if task_withdrawal_status and task.id in task_withdrawal_status %}
                    {% set has_withdrawal_requested = task_withdrawal_status[task.id]['has_withdrawal_requested'] %}
                {% endif %}
                {% if all_submitted %}
                    {% if has_withdrawal_requested %}
                        <button type="button" class="btn btn-secondary" disabled title="该任务已提交撤回申请，正在审核中">
                            已提交撤回申请
                        </button>
                        <span class="text-info ml-2">撤回申请正在审核中</span>
                    {% else %}
                        <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#withdrawModal{{ task.id }}">
                            申请撤回此任务所有评估
                        </button>
                    {% endif %}
                {% endif %}

            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="alert alert-info">
            暂无提交的评估记录
        </div>
    {% endif %}

    <a href="{{ url_for('index') }}" class="btn btn-secondary">返回首页</a>
</div>
{% endblock %}