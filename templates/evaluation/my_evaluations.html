{% extends 'base.html' %}

{% block title %}我的评估记录{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2>我的评估记录</h2>
    
    {# 简化的条件判断逻辑 #}
{% set returned_evaluations = evaluations|selectattr('status', 'equalto', 'returned')|list %}
{% set has_returned_evaluations = returned_evaluations|length > 0 %}

{# 紧凑的统计信息卡片 #}
<div class="card mb-4 shadow-sm">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">评估统计</h5>
        <button class="btn btn-light btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#statsDetail" aria-expanded="false" aria-controls="statsDetail">
            详情
        </button>
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-sm-4 col-md-3">
                <div class="score-card">
                    <p class="text-sm text-muted mb-1">评估记录总数</p>
                    <p class="fs-3 font-bold text-primary">{{ evaluations|length }}</p>
                </div>
            </div>
            <div class="col-sm-4 col-md-3">
                <div class="score-card">
                    <p class="text-sm text-muted mb-1">已退回评估</p>
                    <p class="fs-3 font-bold text-warning">{{ returned_evaluations|length }}</p>
                </div>
            </div>
            <div class="col-sm-4 col-md-3">
                <div class="score-card">
                    <p class="text-sm text-muted mb-1">状态分布</p>
                    <div class="flex flex-wrap gap-1 mt-1">
                        {% set status_counts = evaluations|groupby('status')|list %}
                        {% for status, items in status_counts %}
                            {% set status_color = 'primary' if status == 'submitted' else 'warning' if status == 'returned' else 'info' if status == 'withdrawal_requested' else 'danger' %}
                            <span class="badge bg-{{ status_color }}">{{ status }}: {{ items|length }}</span>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="col-sm-12 col-md-3">
                <div class="score-card h-100 d-flex flex-column justify-center">
                    {% if has_returned_evaluations %}
                        <span class="text-danger font-medium">存在{{ returned_evaluations|length }}条已退回评估</span>
                    {% else %}
                        <span class="text-success font-medium">无已退回评估</span>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="collapse mt-3" id="statsDetail">
            <div class="card card-body border">
                <h6>详细信息</h6>
                {% if returned_evaluations %}
                    <p><strong>已退回评估ID列表:</strong> {{ returned_evaluations|map(attribute='id')|list }}</p>
                {% endif %}
                {% if evaluations %}
                    <p><strong>第一个评估记录详情:</strong></p>
                    <ul class="list-unstyled">
                        <li>ID: {{ evaluations[0].id }}</li>
                        <li>状态: {{ evaluations[0].status }}</li>
                        <li>关联任务ID: {{ evaluations[0].task.id }}</li>
                        <li>任务状态: {{ evaluations[0].task.status }}</li>
                    </ul>
                {% endif %}
            </div>
        </div>
    </div>
</div>
    
{% if has_returned_evaluations %}
    <div class="mb-4">
        <button type="button" class="btn btn-success btn-lg" data-bs-toggle="modal" data-bs-target="#reassessAllModal">
            一键重新评估所有已退回评估
        </button>
    </div>
    {% endif %}

    <!-- 一键重新评估模态框 -->
    <div class="modal fade" id="reassessAllModal" tabindex="-1" role="dialog" aria-labelledby="reassessAllModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reassessAllModalLabel">一键重新评估</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>确认要重新评估所有已退回的评估记录吗？</p>
                    <form action="{{ url_for('batch_reassess_evaluations') }}" method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="modal-footer">
                            <button type="button" class="btn-secondary" data-bs-dismiss="modal">取消</button>
                            <button type="submit" class="btn-primary">确认重新评估</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <hr>

    {% if evaluations %}
        {% for task, task_evaluations in evaluations|groupby('task') %}
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">{{ task.name }}</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>姓名</th>
                                {% for dimension in dimensions %}
                                <th>{{ dimension.name }}({{ (dimension.weight * 100)|int }}%)</th>
                                {% endfor %}
                                <th>合计</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for evaluation in task_evaluations %}
                            <tr>
                                <td>{{ evaluation.evaluatee.name }}</td>
                                {% for dimension in dimensions %}
                                <td>{% set dim = evaluation.scores|selectattr('dimension.id', 'equalto', dimension.id)|first %}{{ (dim.score * (dimension.weight * 20))|int if dim else 0 }}</td>
                                {% endfor %}
                                <td>{{ evaluation.total_score|int }}</td>
                                <td>
                                    <!-- 调试信息: evaluation.id={{ evaluation.id }}, evaluation.status={{ evaluation.status }}, task.status={{ task.status }} -->
                                    {% if evaluation.status == 'submitted' %}
                                        <span class="badge badge-success">已提交</span>
                                    {% elif evaluation.status == 'returned' %}
                                        <span class="badge badge-warning">已退回</span>
                                    {% elif evaluation.status == 'withdrawal_requested' %}
                                        <span class="badge badge-info">撤回申请中</span>
                                    {% else %}
                                        <span class="badge badge-danger">未知状态: {{ evaluation.status }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if evaluation.status == 'submitted' %}
                                        <span class="text-muted">任务级撤回</span>
                                    {% elif evaluation.status == 'returned' %}
                                        <a href="{{ url_for('get_evaluation_form', evaluatee_id=evaluation.evaluatee.id) }}" class="btn btn-primary btn-sm">
                                            重新评估
                                        </a>
                                    {% elif evaluation.status == 'withdrawal_requested' %}
                                        <span class="text-muted">等待审核</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- 任务级申请撤回模态框 -->
                <div class="modal fade" id="withdrawModal{{ task.id }}" tabindex="-1" role="dialog" aria-labelledby="withdrawModalLabel{{ task.id }}" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="withdrawModalLabel{{ task.id }}">申请撤回评估任务: {{ task.name }}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <p>确认要撤回此任务下的所有评估记录吗？</p>
                                <form action="{{ url_for('request_withdrawal', task_id=task.id) }}" method="POST">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <div class="form-group">
                                        <label for="reason{{ task.id }}">撤回原因</label>
                                        <textarea class="form-control" id="reason{{ task.id }}" name="reason" rows="3" required></textarea>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn-secondary" data-bs-dismiss="modal">取消</button>
                                        <button type="submit" class="btn-primary">提交申请</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 任务级申请撤回按钮 -->
                {% set all_submitted = true %}
                {% set has_withdrawal_requested = false %}
                {% for evaluation in task_evaluations %}
                    {% if evaluation.status != 'submitted' %}
                        {% set all_submitted = false %}
                    {% endif %}
                {% endfor %}
                {% if task_withdrawal_status and task.id in task_withdrawal_status %}
                    {% set has_withdrawal_requested = task_withdrawal_status[task.id]['has_withdrawal_requested'] %}
                {% endif %}
                {% if all_submitted %}
                    {% if has_withdrawal_requested %}
                        <button type="button" class="btn btn-secondary" disabled title="该任务已提交撤回申请，正在审核中">
                            已提交撤回申请
                        </button>
                        <span class="text-info ml-2">撤回申请正在审核中</span>
                    {% else %}
                        <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#withdrawModal{{ task.id }}">
                            申请撤回此任务所有评估
                        </button>
                    {% endif %}
                {% endif %}

            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="alert alert-info">
            暂无提交的评估记录
        </div>
    {% endif %}

    <a href="{{ url_for('index') }}" class="btn btn-secondary">返回首页</a>
</div>
{% endblock %}